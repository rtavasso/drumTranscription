FROM nvidia/cuda:11.8.0-devel-ubuntu22.04

ENV PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    TORCH_HOME=/workspace/.cache/torch \
    DEBIAN_FRONTEND=noninteractive \
    VIRTUAL_ENV=/opt/venv \
    PATH="/opt/venv/bin:$PATH"

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3 python3-venv python3-pip python3-dev \
        build-essential ninja-build cmake git pkg-config \
        ffmpeg libsndfile1 ca-certificates && \
    python3 -m venv "$VIRTUAL_ENV" && \
    "$VIRTUAL_ENV/bin/pip" install --no-cache-dir --upgrade pip setuptools wheel && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /workspace

# Install PyTorch 2.7.1 CUDA 11.8 wheel
RUN pip install --no-cache-dir --index-url https://download.pytorch.org/whl/cu118 \
        torch torchaudio

# Pin NumPy < 2 to avoid ABI/runtime issues with older libs used by Demucs deps
RUN pip install --no-cache-dir "numpy<2"
RUN pip install --no-cache-dir demucs

# Install Onsets-and-Frames dependencies (SoundFile, sacred, mir_eval, etc.)
COPY onsets-and-frames/requirements.txt /tmp/onsets_requirements.txt
RUN pip install --no-cache-dir -r /tmp/onsets_requirements.txt

# Install Demucs deps excluding torch/torchaudio to avoid downgrades
# COPY demucs/requirements.txt /tmp/requirements.txt
# RUN awk 'tolower($0) !~ /^(torch|torchaudio)/' /tmp/requirements.txt > /tmp/req_no_torch.txt && \
#     pip install --no-cache-dir -r /tmp/req_no_torch.txt

# Copy repo and install Demucs in editable mode
# COPY demucs /workspace/demucs
# RUN pip install --no-cache-dir -e /workspace/demucs

WORKDIR /workspace
